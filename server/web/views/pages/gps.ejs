<div class="card">
    <div class="card-header">
        <h2>Location Tracking</h2>
        <div class="btn-group">
            <button class="btn" onclick="sendCmd('0xLO')">Get Location</button>
            <select id="gps-interval" onchange="setGpsInterval(this.value)">
                <option value="0" <%= data.interval == 0 ? 'selected' : '' %>>Polling: Off</option>
                <option value="10" <%= data.interval == 10 ? 'selected' : '' %>>Every 10s</option>
                <option value="30" <%= data.interval == 30 ? 'selected' : '' %>>Every 30s</option>
                <option value="60" <%= data.interval == 60 ? 'selected' : '' %>>Every 1m</option>
                <option value="300" <%= data.interval == 300 ? 'selected' : '' %>>Every 5m</option>
            </select>
        </div>
    </div>
    
    <div id="map" style="height: 400px; border-radius: 8px;"></div>
</div>

<div class="card">
    <h2>Location History</h2>
    <% if (!data.list || data.list.length === 0) { %>
    <p class="empty">No location data yet.</p>
    <% } else { %>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Accuracy</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                <% data.list.slice(-20).reverse().forEach(loc => { %>
                <tr>
                    <td><%= loc.latitude?.toFixed(6) %></td>
                    <td><%= loc.longitude?.toFixed(6) %></td>
                    <td><%= loc.accuracy?.toFixed(0) %>m</td>
                    <td><%= new Date(loc.time).toLocaleString() %></td>
                </tr>
                <% }) %>
            </tbody>
        </table>
    </div>
    <% } %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const locations = <%- JSON.stringify(data.list || []) %>;
    const map = L.map('map').setView([0, 0], 2);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);
    
    if (locations.length > 0) {
        const last = locations[locations.length - 1];
        map.setView([last.latitude, last.longitude], 15);
        
        locations.forEach((loc, i) => {
            L.marker([loc.latitude, loc.longitude])
                .addTo(map)
                .bindPopup(`#${i + 1} - ${new Date(loc.time).toLocaleString()}`);
        });
        
        if (locations.length > 1) {
            const line = locations.map(l => [l.latitude, l.longitude]);
            L.polyline(line, {color: '#3b82f6'}).addTo(map);
        }
    }
});

function setGpsInterval(val) {
    fetch(`/gps/${DEVICE_ID}/${val}`, {method: 'POST'})
        .then(r => r.json())
        .then(d => toast(d.success ? 'GPS polling updated' : 'Failed', d.success ? 'success' : 'error'));
}
</script>
