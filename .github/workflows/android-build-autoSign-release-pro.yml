name: Android Auto Release

on:
  push:
    branches:
      - main
      - beta
  workflow_dispatch:

jobs:
  release:
    name: Build & Release APK + AAB
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for Git tags & releases

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Java 17
      - name: Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 4Ô∏è‚É£ Grant Gradle execute
      - name: Grant Gradle permission
        run: chmod +x gradlew

      # 5Ô∏è‚É£ Cache Gradle
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # 6Ô∏è‚É£ Configure SDK path
      - name: Configure SDK path
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > app/local.properties

      # 7Ô∏è‚É£ Generate temporary keystore
      - name: Generate temporary keystore
        id: keystore
        run: |
          KEYSTORE_FILE="$PWD/app/ci-release-keystore.jks"
          KEYSTORE_PASSWORD=$(LC_ALL=C tr -dc A-Za-z0-9 </dev/urandom | head -c 16)
          KEY_ALIAS=ciKey
          KEY_PASSWORD=$(LC_ALL=C tr -dc A-Za-z0-9 </dev/urandom | head -c 16)

          keytool -genkeypair \
            -alias $KEY_ALIAS \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storetype JKS \
            -dname "CN=CI, OU=Dev, O=Company, L=City, S=State, C=US" \
            -keystore $KEYSTORE_FILE \
            -storepass $KEYSTORE_PASSWORD \
            -keypass $KEY_PASSWORD

          echo "KEYSTORE_FILE=$KEYSTORE_FILE" >> $GITHUB_OUTPUT
          echo "KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_OUTPUT
          echo "KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_OUTPUT
          echo "KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_OUTPUT

      # 8Ô∏è‚É£ Determine Semantic Version
      - name: Determine Semantic Version
        id: semver
        run: |
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          IFS='.' read -r MAJOR MINOR PATCH <<< "${LATEST_TAG#v}"
          if [ "${GITHUB_REF##*/}" = "beta" ]; then
            PATCH=$((PATCH+1))
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}-beta"
          else
            PATCH=$((PATCH+1))
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          fi
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Using version $NEW_VERSION"

      # 9Ô∏è‚É£ Update build.gradle version
      - name: Update build.gradle version
        id: version
        run: |
          FILE="app/build.gradle"
          VERSION_CODE=$(grep versionCode $FILE | awk '{print $2}')
          NEW_CODE=$((VERSION_CODE+1))
          VERSION_NAME="${{ steps.semver.outputs.NEW_VERSION }}"
          CLEAN_NAME=$(echo $VERSION_NAME | sed 's/-beta//')
          sed -i "s/versionCode $VERSION_CODE/versionCode $NEW_CODE/" $FILE
          sed -i "s/versionName \".*\"/versionName \"$CLEAN_NAME\"/" $FILE
          echo "VERSION_CODE=$NEW_CODE" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$CLEAN_NAME" >> $GITHUB_OUTPUT
          echo "Updated versionCode to $NEW_CODE and versionName to $CLEAN_NAME"

      # üîü Generate Release Notes
      - name: Generate Release Notes
        id: release-notes
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            echo "Release notes:" > notes.txt
          else
            echo "Release notes since $PREV_TAG:" > notes.txt
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%an)" >> notes.txt
          fi
          cat notes.txt
          echo "RELEASE_NOTES=$(cat notes.txt)" >> $GITHUB_OUTPUT

      # 1Ô∏è‚É£1Ô∏è‚É£ Clean project
      - name: Clean project
        run: ./gradlew clean

      # 1Ô∏è‚É£2Ô∏è‚É£ Build APK + AAB
      - name: Build APK and AAB
        run: |
          ./gradlew assembleRelease bundleRelease \
            -Pandroid.injected.signing.store.file=${{ steps.keystore.outputs.KEYSTORE_FILE }} \
            -Pandroid.injected.signing.store.password=${{ steps.keystore.outputs.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ steps.keystore.outputs.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ steps.keystore.outputs.KEY_PASSWORD }}

      # 1Ô∏è‚É£3Ô∏è‚É£ Create Git Tag
      - name: Create Git Tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.semver.outputs.NEW_VERSION }}
          git push origin ${{ steps.semver.outputs.NEW_VERSION }}

      # 1Ô∏è‚É£4Ô∏è‚É£ Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.semver.outputs.NEW_VERSION }}
          name: Release ${{ steps.semver.outputs.NEW_VERSION }}
          body: |
            Version: ${{ steps.semver.outputs.NEW_VERSION }}
            VersionCode: ${{ steps.version.outputs.VERSION_CODE }}
            Branch: ${{ github.ref_name }}
            Build number: ${{ github.run_number }}

            Release Notes:
            ${{ steps.release-notes.outputs.RELEASE_NOTES }}
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 1Ô∏è‚É£5Ô∏è‚É£ Cleanup
      - name: Cleanup
        run: |
          rm -rf app/build
          rm -f app/ci-release-keystore.jks
          echo "Cleaned build files and keystore."
